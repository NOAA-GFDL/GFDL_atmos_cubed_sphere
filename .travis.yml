language: C

sudo: false

services:
  - docker

env:
  global:
    CACHE_IMAGE: ofuhrer/fv3atm_test
    PATH: ${HOME}/google-cloud-sdk/bin:$PATH
    CLOUDSDK_CORE_DISABLE_PROMPTS: 1
install:
  - curl https://sdk.cloud.google.com | bash;
  - ls -l ${HOME}/google-cloud-sdk/bin
  - which gcloud
  - gcloud --version

before_script:
  - echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account ${GCLOUD_SERVICE_ACCOUNT} --key-file=-
  - gcloud --quiet config set project ${GCLOUD_PROJECT_ID}
  - gcloud --quiet config set compute/zone ${GCLOUD_COMPUTE_ZONE}

jobs:
    include:
        - stage: build docker images
          script:
            - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
            - cd test
            - docker pull $CACHE_IMAGE:base || true
            - docker build
              --target base
              --cache-from $CACHE_IMAGE:base
              --tag $CACHE_IMAGE:base
              --file Dockerfile.base
              "."
            - docker push $CACHE_IMAGE:base
            - cd ../
            - docker pull $CACHE_IMAGE:test || true
            - docker build
              --target test
              --cache-from $CACHE_IMAGE:test
              --tag $CACHE_IMAGE:test
              --file test/Dockerfile.test
              "."
            - docker push $CACHE_IMAGE:test
        - stage: run tests
          script:
            docker run
            -it
            --rm
            --mount type=bind,source=$TRAVIS_BUILD_DIR/test/work,target=/work
            --name=fv3_atm ofuhrer/fv3atm_test:test
